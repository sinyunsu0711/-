<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>숫자 퍼즐 게임</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #1e293b;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            transition: background-color 0.3s ease;
        }
        .container {
            max-width: 900px;
            width: 100%;
            background-color: #fff;
            padding: 2rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease-in-out;
        }
        .grid-cell {
            width: 100%;
            padding-top: 100%; /* Makes the cell a square */
            position: relative;
            border: 1px solid #e2e8f0;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: 700;
            color: #334155;
            background-color: #f8fafc;
            transition: all 0.2s ease-in-out;
            border-radius: 0.5rem;
        }
        .grid-cell.occupied {
            background-color: #e0f2fe;
        }
        .grid-cell:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .grid-cell.occupied:hover {
            background-color: #bae6fd;
        }
        .grid-cell.disabled {
            cursor: not-allowed;
            background-color: #e9e9e9;
            color: #b0b0b0;
        }
        .card-deck {
            min-height: 8rem;
        }
        .drawn-card-placeholder {
            min-height: 4rem;
        }
        /* Fullscreen-specific styles */
        body.is-fullscreen {
            padding: 0;
            background-color: #1e293b;
        }
        body.is-fullscreen .container {
            width: 100vw;
            height: 100vh;
            max-width: none;
            padding: 1rem;
            border-radius: 0;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #1e293b;
        }
        body.is-fullscreen .flex-col.md\\:flex-row {
            flex-direction: column !important;
            align-items: center !important;
        }
        body.is-fullscreen #board {
            width: auto;
            max-width: 90vh; /* Changed from 95vh */
            max-height: 55vh; /* Changed from 60vh */
        }
        body.is-fullscreen .text-4xl {
            font-size: 2.5rem;
        }
        /* Message Box Style */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4">
    <div id="game-container" class="container mx-auto p-8 rounded-3xl shadow-2xl transition-all">
        <h1 class="text-4xl md:text-5xl font-extrabold text-center mb-6 text-slate-900">숫자 퍼즐 게임</h1>

        <div class="flex flex-col md:flex-row items-center justify-between mb-6 space-y-4 md:space-y-0 md:space-x-4">
            <div id="status-card" class="bg-blue-500 text-white p-4 rounded-xl shadow-md flex-1 w-full md:w-auto text-center font-bold">
                <span id="score-text">점수: 0</span>
            </div>
            <div id="drawn-card-container" class="w-full md:w-40 h-16 bg-white border-2 border-dashed border-gray-300 rounded-xl flex items-center justify-center text-gray-500 font-bold text-lg p-2">
                <span id="drawn-card-placeholder">카드 뽑기</span>
            </div>
            <div class="flex-1 flex flex-col space-y-2 w-full md:w-auto">
                <button id="draw-card-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md">
                    카드 뽑기
                </button>
                <button id="discard-card-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md">
                    카드 버리기
                </button>
            </div>
        </div>
        
        <div id="simulation-controls" class="flex flex-col space-y-2 md:flex-row md:space-y-0 md:space-x-4 mb-6">
            <button id="start-simulation-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md flex-1">
                시뮬레이션 시작
            </button>
            <button id="stop-simulation-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md flex-1 hidden">
                시뮬레이션 중지
            </button>
            <button id="restart-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md flex-1">
                다시 시작
            </button>
            <button id="fullscreen-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-xl transition-transform transform hover:scale-105 shadow-md flex-1">
                전체 화면
            </button>
        </div>
        
        <div id="board" class="grid grid-cols-9 gap-1 aspect-square mx-auto mb-6"></div>
        
        <div id="message-area" class="text-center p-4 rounded-xl text-lg font-bold transition-all duration-300"></div>

        <div class="mt-8 p-6 bg-gray-50 rounded-xl shadow-inner">
            <h2 class="text-2xl font-bold mb-4">게임 규칙</h2>
            <ul class="list-disc list-inside space-y-2 text-gray-700">
                <li>1부터 100까지의 숫자 카드를 뽑아 9x9 칸의 보드를 채웁니다.</li>
                <li>**1의 자리 규칙:** 각 3x3 구역 안에는 1의 자리 숫자가 **0부터 8** 또는 **1부터 9**까지 중복 없이 모두 들어가야 합니다.</li>
                <li>**10의 자리 규칙:** 가로 또는 세로로 이어진 9개 칸에는 10의 자리 숫자가 **0부터 8** 또는 **1부터 9**까지 중복 없이 모두 들어가야 합니다.</li>
                <li>**카드 놓기:** 뽑은 카드를 보드의 빈칸에 놓을 수 있습니다. 규칙을 위반하면 카드는 버려집니다.</li>
                <li>**카드 교체:** 이미 채워진 칸을 클릭하여 뽑은 카드와 교체할 수 있습니다.</li>
                <li>**카드 버리기:** 뽑은 카드가 필요 없으면 버릴 수 있습니다. 버릴 때마다 보드의 무작위 칸 하나가 지워지는 페널티가 있습니다.</li>
                <li>버리거나 지워진 카드는 다시 카드 더미로 돌아갑니다.</li>
            </ul>
        </div>
    </div>
    <div id="message-box" class="p-4 bg-white rounded-lg shadow-xl text-center">
        <p id="message-content"></p>
        <button id="message-ok" class="mt-4 px-4 py-2 bg-blue-500 text-white rounded-lg">확인</button>
    </div>
    
    <script>
        // DOM 요소 가져오기
        const boardElement = document.getElementById('board');
        const drawButton = document.getElementById('draw-card-btn');
        const discardButton = document.getElementById('discard-card-btn');
        const startSimulationButton = document.getElementById('start-simulation-btn');
        const stopSimulationButton = document.getElementById('stop-simulation-btn');
        const restartButton = document.getElementById('restart-btn');
        const fullscreenButton = document.getElementById('fullscreen-btn');
        const drawnCardContainer = document.getElementById('drawn-card-container');
        const drawnCardPlaceholder = document.getElementById('drawn-card-placeholder');
        const scoreText = document.getElementById('score-text');
        const messageArea = document.getElementById('message-area');
        const container = document.getElementById('game-container');
        const messageBox = document.getElementById('message-box');
        const messageContent = document.getElementById('message-content');
        const messageOk = document.getElementById('message-ok');
        const body = document.body;

        // 게임 상태 변수
        let cardDeck = [];
        let board = Array.from({ length: 9 }, () => Array(9).fill(0));
        let drawnCard = null;
        let score = 0;
        let filledCells = 0;
        let simulationInterval = null;

        // 게임 초기화
        const initializeGame = () => {
            cardDeck = Array.from({ length: 100 }, (_, i) => i + 1);
            shuffleDeck();
            board = Array.from({ length: 9 }, () => Array(9).fill(0));
            drawnCard = null;
            score = 0;
            filledCells = 0;
            renderBoard();
            updateUI();
            stopSimulation();
        };

        // 카드 섞기
        const shuffleDeck = () => {
            for (let i = cardDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardDeck[i], cardDeck[j]] = [cardDeck[j], cardDeck[i]];
            }
        };

        // UI 갱신
        const updateUI = () => {
            scoreText.textContent = `점수: ${score}`;
            if (drawnCard !== null) {
                drawnCardPlaceholder.textContent = drawnCard;
                drawnCardContainer.classList.remove('text-gray-500', 'border-dashed');
                drawnCardContainer.classList.add('bg-blue-500', 'text-white', 'border-blue-500');
            } else {
                drawnCardPlaceholder.textContent = '카드 뽑기';
                drawnCardContainer.classList.add('text-gray-500', 'border-dashed');
                drawnCardContainer.classList.remove('bg-blue-500', 'text-white', 'border-blue-500');
            }
            // 시뮬레이션 버튼 상태
            if (simulationInterval) {
                startSimulationButton.classList.add('hidden');
                stopSimulationButton.classList.remove('hidden');
            } else {
                startSimulationButton.classList.remove('hidden');
                stopSimulationButton.classList.add('hidden');
            }
        };

        // 보드 렌더링
        const renderBoard = () => {
            boardElement.innerHTML = '';
            board.forEach((row, rowIndex) => {
                row.forEach((cellValue, colIndex) => {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell rounded-md transition-all duration-200 ease-in-out ' + (cellValue !== 0 ? 'occupied' : '');
                    cell.dataset.row = rowIndex;
                    cell.dataset.col = colIndex;

                    // 3x3 구역 테두리 스타일링
                    if (rowIndex % 3 === 0 && rowIndex > 0) {
                        cell.style.borderTopWidth = '3px';
                        cell.style.borderTopColor = '#60a5fa';
                    }
                    if (colIndex % 3 === 0 && colIndex > 0) {
                        cell.style.borderLeftWidth = '3px';
                        cell.style.borderLeftColor = '#60a5fa';
                    }

                    cell.textContent = cellValue === 0 ? '' : cellValue;
                    boardElement.appendChild(cell);
                });
            });
        };

        // 메시지 표시 (임시 메시지 박스로 변경)
        const setMessage = (message, isError = false) => {
            messageContent.textContent = message;
            messageBox.style.display = 'block';
            messageBox.style.backgroundColor = isError ? '#fecaca' : '#dcfce7';
            messageContent.style.color = isError ? '#991b1b' : '#14532d';
            messageOk.focus();
        };

        // 카드 놓기 유효성 검사
        const isPlacementValid = (card, row, col) => {
            const unit = card % 10;
            const ten = Math.floor(card / 10);
            const subgridStartRow = Math.floor(row / 3) * 3;
            const subgridStartCol = Math.floor(col / 3) * 3;
            
            // 1의 자리 규칙 확인 (3x3 구역)
            for (let i = subgridStartRow; i < subgridStartRow + 3; i++) {
                for (let j = subgridStartCol; j < subgridStartCol + 3; j++) {
                    if (board[i][j] !== 0 && board[i][j] % 10 === unit) {
                        return false;
                    }
                }
            }
            
            // 10의 자리 규칙 확인 (가로줄)
            for (let j = 0; j < 9; j++) {
                if (board[row][j] !== 0 && Math.floor(board[row][j] / 10) === ten) {
                    return false;
                }
            }
            
            // 10의 자리 규칙 확인 (세로줄)
            for (let i = 0; i < 9; i++) {
                if (board[i][col] !== 0 && Math.floor(board[i][col] / 10) === ten) {
                    return false;
                }
            }
            return true;
        };

        // 이벤트 핸들러
        const handleDrawCard = () => {
            if (drawnCard !== null) {
                setMessage("이미 뽑은 카드가 있습니다. 먼저 사용하거나 버리세요.", true);
                return;
            }
            if (cardDeck.length === 0) {
                setMessage("카드 더미가 비었습니다. 게임을 재시작하세요.", true);
                return;
            }
            drawnCard = cardDeck.pop();
            updateUI();
        };

        const handleDiscardCard = () => {
            if (drawnCard === null) {
                setMessage("버릴 카드가 없습니다. 먼저 카드를 뽑으세요.", true);
                return;
            }
            cardDeck.push(drawnCard);
            drawnCard = null;
            score -= 20;
            
            if (filledCells > 0) {
                const filledIndices = [];
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (board[i][j] !== 0) {
                            filledIndices.push({ row: i, col: j });
                        }
                    }
                }
                const randomCell = filledIndices[Math.floor(Math.random() * filledIndices.length)];
                const removedCard = board[randomCell.row][randomCell.col];
                cardDeck.push(removedCard);
                board[randomCell.row][randomCell.col] = 0;
                filledCells--;
                setMessage(`카드를 버렸습니다. 무작위 칸 (${randomCell.row}, ${randomCell.col})이 지워졌습니다.`);
            } else {
                setMessage("카드를 버렸지만, 채워진 칸이 없어 지울 칸이 없습니다.");
            }
            
            renderBoard();
            updateUI();
        };
        
        const handleBoardClick = (e) => {
            if (drawnCard === null) {
                setMessage("먼저 카드를 뽑으세요.", true);
                return;
            }

            const cell = e.target.closest('.grid-cell');
            if (!cell) return;

            const row = parseInt(cell.dataset.row);
            const col = parseInt(cell.dataset.col);

            const existingCard = board[row][col];
            
            if (existingCard === 0) {
                // 새로운 카드 놓기
                if (isPlacementValid(drawnCard, row, col)) {
                    board[row][col] = drawnCard;
                    drawnCard = null;
                    filledCells++;
                    score += 10;
                    setMessage("카드를 성공적으로 놓았습니다.");
                } else {
                    setMessage("규칙에 맞지 않아 놓을 수 없습니다. 카드가 더미로 돌아갑니다.", true);
                    cardDeck.push(drawnCard);
                    drawnCard = null;
                }
            } else {
                // 카드 교체
                const oldCard = existingCard;
                board[row][col] = 0; // 임시 제거 후 유효성 검사
                if (isPlacementValid(drawnCard, row, col)) {
                    board[row][col] = drawnCard;
                    cardDeck.push(oldCard);
                    drawnCard = null;
                    score += 5;
                    setMessage("카드를 성공적으로 교체했습니다.");
                } else {
                    board[row][col] = oldCard; // 원상 복구
                    setMessage("교체 시 규칙 위반입니다. 교체하지 않았습니다.", true);
                }
            }
            
            renderBoard();
            updateUI();
        };

        const startSimulation = () => {
            if (simulationInterval) return;
            setMessage("시뮬레이션 시작...");
            simulationInterval = setInterval(() => {
                const drawnCard = cardDeck.pop();
                if (!drawnCard) {
                    stopSimulation();
                    setMessage("시뮬레이션 종료: 카드 더미가 비었습니다.");
                    return;
                }
                
                let placementFound = false;
                for (let i = 0; i < 9; i++) {
                    for (let j = 0; j < 9; j++) {
                        if (board[i][j] === 0) {
                            if (isPlacementValid(drawnCard, i, j)) {
                                board[i][j] = drawnCard;
                                filledCells++;
                                score += 10;
                                setMessage(`시뮬레이션: (${i}, ${j})에 ${board[i][j]} 놓기`);
                                placementFound = true;
                                break;
                            }
                        }
                    }
                    if (placementFound) break;
                }

                if (placementFound) {
                    renderBoard();
                    updateUI();
                } else {
                    cardDeck.push(drawnCard);
                    shuffleDeck();
                    score -= 20;
                    setMessage("시뮬레이션: 놓을 곳이 없어 카드를 버립니다. 점수 -20.");
                    renderBoard();
                    updateUI();
                }
                
            }, 500); // 0.5초마다 실행
        };

        const stopSimulation = () => {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
                setMessage("시뮬레이션 중지.");
                updateUI();
            }
        };

        const handleFullscreen = () => {
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => {
                    setMessage(`전체 화면 모드를 활성화하는 중 오류가 발생했습니다: ${err.message}`, true);
                });
            } else {
                document.exitFullscreen();
            }
        };

        // 이벤트 리스너 등록
        document.addEventListener('DOMContentLoaded', initializeGame);
        drawButton.addEventListener('click', handleDrawCard);
        discardButton.addEventListener('click', handleDiscardCard);
        boardElement.addEventListener('click', handleBoardClick);
        startSimulationButton.addEventListener('click', startSimulation);
        stopSimulationButton.addEventListener('click', stopSimulation);
        restartButton.addEventListener('click', () => {
            stopSimulation();
            initializeGame();
            setMessage("게임이 다시 시작되었습니다.");
        });
        fullscreenButton.addEventListener('click', handleFullscreen);
        messageOk.addEventListener('click', () => {
            messageBox.style.display = 'none';
        });

        // 전체 화면 상태 변경 감지
        document.addEventListener('fullscreenchange', () => {
            if (document.fullscreenElement) {
                body.classList.add('is-fullscreen');
                fullscreenButton.textContent = "전체 화면 종료";
            } else {
                body.classList.remove('is-fullscreen');
                fullscreenButton.textContent = "전체 화면";
            }
        });

        // 페이지 로드 시 게임 초기화
        initializeGame();
    </script>
</body>
</html>
